<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>企业级RAG知识库系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --dark-color: #34495e;
            --light-color: #ecf0f1;
        }

        body {
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .main-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rag-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            max-width: 1000px;
            width: 100%;
            margin: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .header .subtitle {
            color: var(--dark-color);
            font-size: 1.1rem;
            opacity: 0.8;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .feature-card {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
            cursor: pointer;
        }

        .feature-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .feature-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        .feature-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        .feature-desc {
            color: var(--dark-color);
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .chat-container {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
            margin-top: 2rem;
        }

        .chat-header {
            display: flex;
            align-items: center;
            justify-content: between;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--light-color);
            margin-bottom: 1rem;
        }

        .chat-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--primary-color);
            margin: 0;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .input-group {
            position: relative;
        }

        .form-control {
            border-radius: 50px;
            padding: 1rem 1.5rem;
            border: 2px solid var(--light-color);
            transition: all 0.3s ease;
        }

        .form-control:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 0.2rem rgba(52, 152, 219, 0.25);
        }

        .btn-primary {
            background: var(--secondary-color);
            border: none;
            border-radius: 50px;
            padding: 1rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
        }

        .response-area {
            min-height: 200px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 1rem;
            border: 2px dashed var(--light-color);
        }

        .response-content {
            font-size: 1rem;
            line-height: 1.6;
            color: var(--dark-color);
        }

        .loading {
            display: none;
            text-align: center;
            color: var(--secondary-color);
        }

        .spinner-border {
            width: 2rem;
            height: 2rem;
        }

        .stats-row {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid var(--light-color);
        }

        .stat-card {
            background: linear-gradient(135deg, var(--secondary-color), #3742fa);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            opacity: 0.9;
            font-size: 0.9rem;
        }

        .modal-content {
            border-radius: 20px;
            border: none;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--secondary-color), #3742fa);
            color: white;
            border-radius: 20px 20px 0 0;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="rag-card">
            <!-- 头部 -->
            <div class="header">
                <h1><i class="fas fa-brain text-primary me-3"></i>企业级RAG知识库系统</h1>
                <p class="subtitle">基于LightRAG架构的智能检索增强生成平台</p>
            </div>

            <!-- 功能卡片网格 -->
            <div class="feature-grid">
                <div class="feature-card" onclick="openModal('chatModal')">
                    <i class="fas fa-comments feature-icon text-primary"></i>
                    <div class="feature-title">智能问答</div>
                    <div class="feature-desc">基于RAG技术的智能对话问答</div>
                </div>

                <div class="feature-card" onclick="openModal('uploadModal')">
                    <i class="fas fa-upload feature-icon text-success"></i>
                    <div class="feature-title">文档上传</div>
                    <div class="feature-desc">支持多格式文档智能解析</div>
                </div>

                <div class="feature-card" onclick="openModal('searchModal')">
                    <i class="fas fa-search feature-icon text-warning"></i>
                    <div class="feature-title">混合检索</div>
                    <div class="feature-desc">向量+图谱+全文混合检索</div>
                </div>

                <div class="feature-card" onclick="window.open('/docs', '_blank')">
                    <i class="fas fa-book feature-icon text-info"></i>
                    <div class="feature-title">API文档</div>
                    <div class="feature-desc">完整的RESTful API文档</div>
                </div>
            </div>

            <!-- 快速问答区域 -->
            <div class="chat-container">
                <div class="chat-header">
                    <h3 class="chat-title"><i class="fas fa-robot me-2"></i>快速问答</h3>
                    <div class="status-indicator">
                        <span class="status-dot"></span>
                        <span class="text-muted small">系统在线</span>
                    </div>
                </div>

                <form onsubmit="quickChat(event)">
                    <div class="input-group mb-3">
                        <input type="text"
                               class="form-control"
                               id="quickQuestion"
                               placeholder="在这里输入你的问题..."
                               required>
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-paper-plane me-2"></i>发送
                        </button>
                    </div>
                </form>

                <div class="response-area">
                    <div class="loading" id="quickLoading">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                        <p class="mt-2 mb-0">AI正在思考中...</p>
                    </div>
                    <div class="response-content" id="quickResponse">
                        <i class="fas fa-lightbulb text-warning me-2"></i>
                        欢迎使用企业级RAG知识库系统！请输入您的问题，我将基于知识库为您提供准确的答案。
                    </div>
                </div>
            </div>

            <!-- 统计信息 -->
            <div class="stats-row">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-number" id="docCount">-</div>
                            <div class="stat-label">文档数量</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-number" id="chunkCount">-</div>
                            <div class="stat-label">知识块</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-number" id="entityCount">-</div>
                            <div class="stat-label">实体数量</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="stat-card">
                            <div class="stat-number" id="relationCount">-</div>
                            <div class="stat-label">关系数量</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 智能问答模态框 -->
    <div class="modal fade" id="chatModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-comments me-2"></i>智能问答助手</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        支持多种检索模式：向量检索、知识图谱检索、全文检索、混合检索
                    </div>
                    <!-- 这里可以添加更详细的聊天界面 -->
                    <p>完整的聊天界面正在开发中，您可以使用上方的快速问答功能。</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 文档上传模态框 -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-upload me-2"></i>文档上传</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        支持格式：PDF、Word(.docx/.doc)、文本(.txt)、Markdown(.md)、HTML 文件
                    </div>

                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="documentFile" class="form-label">选择文档</label>
                            <input type="file" class="form-control" id="documentFile" name="file"
                                   accept=".pdf,.docx,.doc,.txt,.md,.html" required>
                            <div class="form-text">最大文件大小：100MB</div>
                        </div>

                        <div class="upload-progress" id="uploadProgress" style="display: none;">
                            <div class="progress mb-2">
                                <div class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <div class="text-center">
                                <small class="text-muted">正在上传文档...</small>
                            </div>
                        </div>

                        <div class="upload-result" id="uploadResult" style="display: none;"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" id="uploadBtn" onclick="uploadDocument()">
                        <i class="fas fa-upload me-2"></i>上传文档
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 混合检索模态框 -->
    <div class="modal fade" id="searchModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-search me-2"></i>混合检索</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-cogs me-2"></i>
                        混合检索结合向量相似度、知识图谱关系和全文匹配，提供最优检索结果
                    </div>
                    <p>高级检索功能正在开发中，敬请期待！</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 打开模态框
        function openModal(modalId) {
            const modal = new bootstrap.Modal(document.getElementById(modalId));
            modal.show();
        }

        // 快速问答功能
        async function quickChat(event) {
            event.preventDefault();

            const question = document.getElementById('quickQuestion').value;
            const loading = document.getElementById('quickLoading');
            const response = document.getElementById('quickResponse');

            if (!question.trim()) return;

            // 显示加载状态
            loading.style.display = 'block';
            response.style.display = 'none';

            try {
                const result = await fetch('/api/v1/chat/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: question,
                        mode: 'hybrid',
                        top_k: 5
                    })
                });

                const data = await result.json();

                // 隐藏加载状态
                loading.style.display = 'none';
                response.style.display = 'block';

                if (data.success) {
                    response.innerHTML = `
                        <div class="alert alert-success mb-3">
                            <strong><i class="fas fa-robot me-2"></i>AI回答：</strong>
                        </div>
                        <div class="mb-3">${data.data.answer}</div>
                        <div class="small text-muted">
                            <i class="fas fa-clock me-1"></i>响应时间: ${data.data.response_time?.toFixed(2)}s |
                            <i class="fas fa-brain me-1"></i>置信度: ${(data.data.confidence * 100)?.toFixed(1)}%
                        </div>
                    `;
                } else {
                    response.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            抱歉，处理您的问题时出现错误：${data.message}
                        </div>
                    `;
                }
            } catch (error) {
                // 隐藏加载状态
                loading.style.display = 'none';
                response.style.display = 'block';

                response.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        网络错误，请稍后重试。
                    </div>
                `;
                console.error('聊天错误:', error);
            }

            // 清空输入框
            document.getElementById('quickQuestion').value = '';
        }

        // 加载统计信息
        async function loadStatistics() {
            try {
                const response = await fetch('/system/info');
                const data = await response.json();

                if (data.statistics) {
                    document.getElementById('docCount').textContent = data.statistics.documents || 0;
                    document.getElementById('chunkCount').textContent = data.statistics.chunks || 0;
                    document.getElementById('entityCount').textContent = data.statistics.entities || 0;
                    document.getElementById('relationCount').textContent = data.statistics.relations || 0;
                }
            } catch (error) {
                console.error('加载统计信息失败:', error);
            }
        }

        // 文档上传功能
        async function uploadDocument() {
            const fileInput = document.getElementById('documentFile');
            const uploadBtn = document.getElementById('uploadBtn');
            const uploadProgress = document.getElementById('uploadProgress');
            const uploadResult = document.getElementById('uploadResult');

            // 检查是否选择了文件
            if (!fileInput.files.length) {
                alert('请选择要上传的文件');
                return;
            }

            const file = fileInput.files[0];

            // 检查文件大小 (100MB = 100 * 1024 * 1024 bytes)
            const maxSize = 100 * 1024 * 1024;
            if (file.size > maxSize) {
                alert('文件大小超过限制（100MB）');
                return;
            }

            // 显示进度条
            uploadProgress.style.display = 'block';
            uploadResult.style.display = 'none';
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>上传中...';

            try {
                const formData = new FormData();
                formData.append('file', file);

                // 上传文件
                const response = await fetch('/api/v1/documents/upload', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        // Note: 这里暂时不添加认证头，因为需要登录功能
                        // 在生产环境中应该添加 JWT token
                    }
                });

                const result = await response.json();

                // 隐藏进度条
                uploadProgress.style.display = 'none';

                if (response.ok) {
                    // 上传成功
                    uploadResult.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            ${result.message}
                            <br><small class="text-muted">文档ID: ${result.document_id}</small>
                        </div>
                    `;
                    uploadResult.style.display = 'block';

                    // 清除文件输入
                    fileInput.value = '';

                    // 3秒后自动关闭模态框
                    setTimeout(() => {
                        const modal = bootstrap.Modal.getInstance(document.getElementById('uploadModal'));
                        modal.hide();
                        uploadResult.style.display = 'none';
                    }, 3000);
                } else {
                    // 上传失败
                    uploadResult.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            上传失败: ${result.detail || result.message || '未知错误'}
                        </div>
                    `;
                    uploadResult.style.display = 'block';
                }
            } catch (error) {
                console.error('Upload error:', error);

                uploadProgress.style.display = 'none';
                uploadResult.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        网络错误，请检查网络连接后重试
                    </div>
                `;
                uploadResult.style.display = 'block';
            } finally {
                // 恢复按钮状态
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload me-2"></i>上传文档';
            }
        }

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            loadStatistics();

            // 每30秒更新一次统计信息
            setInterval(loadStatistics, 30000);
        });
    </script>
</body>
</html>